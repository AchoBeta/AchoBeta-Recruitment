<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.achobeta.domain.schedule.model.dao.mapper.InterviewScheduleMapper">

    <resultMap id="ScheduleMap" type="com.achobeta.domain.schedule.model.vo.ScheduleVO">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="participationId" column="participation_id" jdbcType="BIGINT"/>
        <result property="startTime" column="start_time" jdbcType="TIMESTAMP"/>
        <result property="endTime" column="end_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="ScheduleResumeMap" extends="ScheduleMap" type="com.achobeta.domain.schedule.model.vo.ScheduleResumeVO">
        <association property="simpleStudentVO" columnPrefix="r_" resultMap="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.SimpleResumeMap" />
    </resultMap>

    <resultMap id="ScheduleDetailMap" extends="ScheduleResumeMap" type="com.achobeta.domain.schedule.model.vo.ScheduleDetailVO">
        <collection property="interviewerVOList" columnPrefix="m_" resultMap="com.achobeta.domain.schedule.model.dao.mapper.InterviewerMapper.InterviewerMap"/>
        <collection property="interviewVOList" columnPrefix="i_" resultMap="com.achobeta.domain.interview.model.dao.mapper.InterviewMapper.InterviewMap"/>
    </resultMap>

    <resultMap id="ParticipationScheduleMap" type="com.achobeta.domain.schedule.model.vo.ParticipationScheduleVO">
        <id property="participationId" column="id" jdbcType="BIGINT"/>
        <association property="simpleStudentVO" columnPrefix="r_" resultMap="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.SimpleResumeMap" />
        <collection property="scheduleVOS" columnPrefix="s_" resultMap="ScheduleMap"/>
    </resultMap>

    <select id="getInterviewScheduleList" resultMap="ScheduleDetailMap">
        select
            -- 面试预约与面试官多对多，在本条 sql 容易出现重复行
            distinct s.id, s.participation_id, s.start_time, s.end_time,
            i.id i_id, i.title i_title, i.status i_status,
            <include refid="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.Simple_Column_List" />
        from user m
            left join interviewer ir on m.id = ir.manager_id and m.is_deleted = 0 and ir.is_deleted = 0
            left join interview_schedule s on ir.schedule_id = s.id and ir.is_deleted = 0 and s.is_deleted = 0
            left join activity_participation p on p.id = s.participation_id and p.is_deleted = 0 and s.is_deleted = 0
            left join user stu on p.stu_id = stu.id and p.is_deleted = 0 and stu.is_deleted = 0
            left join recruitment_activity a on p.act_id = a.id and p.is_deleted = 0 and a.is_deleted = 0
            left join recruitment_batch b on a.batch_id = b.id and a.is_deleted = 0 and b.is_deleted = 0
            left join stu_resume r on r.batch_id = b.id and r.user_id = stu.id and r.is_deleted = 0 and b.is_deleted = 0 and stu.is_deleted = 0
            left join interview i on i.schedule_id = s.id and i.is_deleted = 0 and s.is_deleted = 0
        <where>
            s.id is not null and m.is_deleted = 0
            <if test="managerId != null">
                and m.id = #{managerId,jdbcType=BIGINT}
            </if>
            <if test="condition.batchId != null">
                and b.id = #{condition.batchId,jdbcType=BIGINT}
            </if>
            <if test="condition.actId != null">
                and a.id = #{condition.actId,jdbcType=BIGINT}
            </if>
        </where>
        order by s.start_time asc, s.end_time asc
    </select>

    <select id="querySituations" parameterType="java.lang.Long" resultMap="ParticipationScheduleMap">
        select
            p.id, s.id s_id, s.participation_id s_participation_id, s.start_time s_start_time, s.end_time s_end_time,
            <include refid="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.Simple_Column_List" />
        from activity_participation p
             left join user stu on p.stu_id = stu.id and p.is_deleted = 0 and stu.is_deleted = 0
             left join recruitment_activity a on p.act_id = a.id and p.is_deleted = 0 and a.is_deleted = 0
             left join recruitment_batch b on a.batch_id = b.id and a.is_deleted = 0 and b.is_deleted = 0
             left join stu_resume r on r.batch_id = b.id and r.user_id = stu.id and r.is_deleted = 0 and b.is_deleted = 0 and stu.is_deleted = 0
             left join interview_schedule s on s.participation_id = p.id and s.is_deleted = 0 and p.is_deleted = 0
        <where>
            a.id = #{condition.actId,jdbcType=BIGINT} and r.id is not null and p.is_deleted = 0
            -- and r.status 放在外面，foreach 内部为空导致没有 in，可能会因为 r.status 为 0 而没有查询到一些行
            <if test="condition.statusList != null">
                <foreach collection="condition.statusList" item="status" open="and r.status in (" close=")" separator=",">
                    #{status,jdbcType=INTEGER}
                </foreach>
            </if>
        </where>
        order by s.start_time asc, s.end_time asc
    </select>

    <select id="getSituationsByParticipationId" parameterType="java.lang.Long" resultMap="ParticipationScheduleMap">
        select
            p.id, s.id s_id, s.start_time s_start_time, s.end_time s_end_time,
            <include refid="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.Simple_Column_List" />
        from activity_participation p
             left join user stu on p.stu_id = stu.id and p.is_deleted = 0 and stu.is_deleted = 0
             left join recruitment_activity a on p.act_id = a.id and p.is_deleted = 0 and a.is_deleted = 0
             left join recruitment_batch b on a.batch_id = b.id and a.is_deleted = 0 and b.is_deleted = 0
             left join stu_resume r on r.batch_id = b.id and r.user_id = stu.id and r.is_deleted = 0 and b.is_deleted = 0 and stu.is_deleted = 0
             left join interview_schedule s on s.participation_id = p.id and s.is_deleted = 0 and p.is_deleted = 0
        where p.id = #{participationId,jdbcType=BIGINT} and r.id is not null and p.is_deleted = 0
        order by s.start_time asc, s.end_time asc
    </select>

    <select id="getInterviewerScheduleDetail" parameterType="java.lang.Long" resultMap="ScheduleDetailMap">
        select
            s.id, s.participation_id, s.start_time, s.end_time,
            m.id m_id, m.username m_username, m.nickname m_nickname, m.email m_email,
            m.phone_number m_phone_number, m.avatar m_acvtar,
            <include refid="com.achobeta.domain.student.model.dao.mapper.StuResumeMapper.Simple_Column_List" />
        from interview_schedule s
             left join activity_participation p on p.id = s.participation_id and p.is_deleted = 0 and s.is_deleted = 0
             left join user stu on p.stu_id = stu.id and p.is_deleted = 0 and stu.is_deleted = 0
             left join recruitment_activity a on p.act_id = a.id and p.is_deleted = 0 and a.is_deleted = 0
             left join recruitment_batch b on a.batch_id = b.id and a.is_deleted = 0 and b.is_deleted = 0
             left join stu_resume r on r.batch_id = b.id and r.user_id = stu.id and r.is_deleted = 0 and b.is_deleted = 0 and stu.is_deleted = 0
             left join interviewer i on s.id = i.schedule_id and s.is_deleted = 0 and i.is_deleted = 0
             left join user m on m.id = i.manager_id and m.is_deleted = 0 and i.is_deleted = 0
        where s.id = #{scheduleId,jdbcType=BIGINT} and s.is_deleted = 0
        order by s.start_time asc, s.end_time asc
    </select>

</mapper>
